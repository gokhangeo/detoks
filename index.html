<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Güler Detoks Asistanı</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Temel Stil Ayarları */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* bg-slate-900 */
            color: #f8fafc; /* text-slate-50 */
        }
        /* Özel Kaydırma Çubuğu Stilleri */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #06b6d4; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #0891b2; }
        /* Yükleme animasyonu için */
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Diyet Tablosu Stilleri */
        .diet-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.875rem;
        }
        .diet-table th, .diet-table td {
            border: 1px solid #334155; /* bg-slate-700 */
            padding: 0.75rem;
            text-align: left;
            vertical-align: top;
        }
        .diet-table th {
            background-color: #1e293b; /* bg-slate-800 */
            font-weight: bold;
            color: #94a3b8; /* text-slate-400 */
        }
        .diet-table td {
            background-color: #0f172a; /* bg-slate-900 */
        }
        .diet-table ul {
            padding-left: 1rem;
            margin: 0;
            list-style-position: inside;
        }
    </style>
</head>
<body class="min-h-screen p-4 pb-24">

    <!-- Ana Uygulama Konteyneri -->
    <div id="app-container">
        <!-- Başlık Bölümü -->
        <header class="text-center mb-6">
            <div class="flex items-center justify-center gap-3">
                <i data-lucide="dna" class="text-cyan-400 w-8 h-8"></i>
                <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-teal-300">
                    Güler Detoks Asistanı
                </h1>
            </div>
            <p class="text-gray-400 mt-2">Sağlıklı yaşama modern bir dokunuş</p>
            <!-- Hata Mesajı Alanı -->
            <div id="error-message" class="hidden mt-4 bg-red-500/20 border border-red-500 text-red-300 p-3 rounded-lg"></div>
        </header>

        <!-- Ana İçerik Alanı -->
        <main>
            <!-- Tarif Kategorileri Görünümü -->
            <div id="recipe-categories-view">
                 <h2 class="text-2xl font-bold text-cyan-300 mb-4 text-center">Tarif Kategorileri</h2>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button data-category="detox" class="category-btn bg-teal-500 hover:bg-teal-400 text-slate-900 font-bold py-8 px-4 rounded-lg flex flex-col items-center justify-center gap-2 transition-colors duration-300">
                        <i data-lucide="blender" class="w-8 h-8"></i>
                        <span>Genel Detoks Tarifleri</span>
                    </button>
                    <button data-category="lipoedema" class="category-btn bg-indigo-500 hover:bg-indigo-400 text-slate-900 font-bold py-8 px-4 rounded-lg flex flex-col items-center justify-center gap-2 transition-colors duration-300">
                        <i data-lucide="soup" class="w-8 h-8"></i>
                        <span>Lipödem Destek Çorbaları</span>
                    </button>
                    <button data-category="diuretic" class="category-btn bg-sky-500 hover:bg-sky-400 text-slate-900 font-bold py-8 px-4 rounded-lg flex flex-col items-center justify-center gap-2 transition-colors duration-300">
                        <i data-lucide="glass-water" class="w-8 h-8"></i>
                        <span>Ödem Atıcı İçecekler</span>
                    </button>
                 </div>
                 <div id="recipe-list-view" class="hidden mt-6">
                    <button id="back-to-categories-btn" class="mb-4 text-cyan-400 hover:text-cyan-300 flex items-center gap-2"><i data-lucide="arrow-left"></i> Geri Dön</button>
                    <h2 id="recipe-list-title" class="text-2xl font-bold text-cyan-300 mb-4"></h2>
                    <div id="recipes-loader" class="text-center text-gray-400"><p>Yapay zeka şefimiz tarifleri hazırlıyor...</p></div>
                    <div id="recipes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    <button id="refresh-category-btn" class="hidden mt-6 w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors">
                        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                        Bu Kategori İçin Yeni Tarifler Getir
                    </button>
                 </div>
            </div>

            <!-- Diyet Listesi Görünümü -->
            <div id="diet-view" class="hidden bg-white/5 backdrop-blur-sm rounded-2xl p-6 shadow-lg border border-white/10">
                <h2 class="text-2xl font-bold text-cyan-300 mb-4">Beslenme Planları</h2>
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <button id="lipoedema-diet-btn" class="w-full bg-indigo-500 hover:bg-indigo-400 text-slate-900 font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors">
                        <i data-lucide="activity" class="w-5 h-5"></i>
                        Lipödem Diyeti Oluştur
                    </button>
                    <button id="general-diet-btn" class="w-full bg-green-500 hover:bg-green-400 text-slate-900 font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors">
                        <i data-lucide="heart-pulse" class="w-5 h-5"></i>
                        Genel Diyet Listesi Oluştur
                    </button>
                </div>
                <div id="diet-loader" class="hidden text-center text-gray-400 my-4"><p>Yapay zeka diyetisyeniniz sizin için en uygun listeyi hazırlıyor...</p></div>
                <div id="diet-list-container" class="hidden">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold text-cyan-300">Oluşturulan Diyet Listesi</h3>
                        <button id="copy-diet-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2 text-sm"><i data-lucide="copy" class="w-4 h-4"></i> Kopyala</button>
                    </div>
                    <div id="diet-list-content" class="custom-scrollbar overflow-x-auto"></div>
                </div>
            </div>

            <!-- Diğer Görünümler (Günlük, Kilo) -->
            <div id="log-view" class="hidden bg-white/5 backdrop-blur-sm rounded-2xl p-6 shadow-lg border border-white/10">
                <h2 class="text-2xl font-bold text-cyan-300 mb-4">Tüketim Günlüğüm</h2>
                <div id="log-list" class="space-y-3 max-h-96 overflow-y-auto pr-2 custom-scrollbar"><p class="text-gray-400">Henüz bir şey içmediniz.</p></div>
            </div>
            <div id="weight-view" class="hidden bg-white/5 backdrop-blur-sm rounded-2xl p-6 shadow-lg border border-white/10 space-y-6">
                <h2 class="text-2xl font-bold text-cyan-300">Kilo Gelişim Panosu</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="bg-slate-800/50 p-4 rounded-lg"><p class="text-sm text-gray-400">Başlangıç</p><p id="start-weight" class="text-2xl font-bold text-white">- kg</p></div>
                    <div class="bg-slate-800/50 p-4 rounded-lg"><p class="text-sm text-gray-400">Mevcut</p><p id="current-weight" class="text-2xl font-bold text-white">- kg</p></div>
                    <div class="bg-slate-800/50 p-4 rounded-lg"><p class="text-sm text-gray-400">Toplam Değişim</p><p id="total-change" class="text-2xl font-bold text-white">- kg</p></div>
                </div>
                <div class="h-64"><canvas id="weight-chart"></canvas></div>
                <form id="weight-form" class="flex gap-2">
                    <input id="new-weight-input" type="number" step="0.1" placeholder="Örn: 75.5" class="w-full bg-gray-700 text-white placeholder-gray-400 rounded-lg p-3 border-2 border-transparent focus:outline-none focus:border-teal-400 transition-colors" required />
                    <button type="submit" class="bg-teal-500 hover:bg-teal-400 text-slate-900 font-bold py-3 px-4 rounded-lg transition-colors">Ekle</button>
                </form>
                <div>
                    <h3 class="text-xl font-bold text-cyan-300 mb-3">Kayıt Geçmişi</h3>
                    <div id="weight-history-list" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar pr-2"><p class="text-gray-400 text-sm">Henüz kilo kaydı girmediniz.</p></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Alt Navigasyon Çubuğu -->
    <nav class="fixed bottom-0 left-0 right-0 bg-gray-900/80 backdrop-blur-sm border-t border-cyan-500/30 p-2 flex justify-around">
        <button data-view="recipe-categories" class="nav-btn flex flex-col items-center justify-center w-full py-2 rounded-lg transition-colors duration-300 text-cyan-400 bg-cyan-500/10"><i data-lucide="book-open"></i><span class="text-xs mt-1 font-medium">Tarifler</span></button>
        <button data-view="diet" class="nav-btn flex flex-col items-center justify-center w-full py-2 rounded-lg transition-colors duration-300 text-gray-400 hover:bg-gray-700/50"><i data-lucide="clipboard-list"></i><span class="text-xs mt-1 font-medium">Beslenme Planı</span></button>
        <button data-view="log" class="nav-btn flex flex-col items-center justify-center w-full py-2 rounded-lg transition-colors duration-300 text-gray-400 hover:bg-gray-700/50"><i data-lucide="glass-water"></i><span class="text-xs mt-1 font-medium">Günlüğüm</span></button>
        <button data-view="weight" class="nav-btn flex flex-col items-center justify-center w-full py-2 rounded-lg transition-colors duration-300 text-gray-400 hover:bg-gray-700/50"><i data-lucide="weight"></i><span class="text-xs mt-1 font-medium">Kilo Takibi</span></button>
    </nav>

    <!-- Uygulama Mantığı -->
    <script type="module">
        // --- DEĞİŞKENLER VE SABİTLER ---
        const GEMINI_API_KEY = "AIzaSyBPpW33vp0fo5rf9vEiJ4ii3dHC-WXxX50";
        let weightChart;
        let localRecipes = [];
        let dailyLog = [];
        let weightData = [];
        let chatHistory = []; // Yapay zeka ile konuşma geçmişi için

        // --- DOM ELEMENTLERİ ---
        const views = {
            'recipe-categories': document.getElementById('recipe-categories-view'),
            'diet': document.getElementById('diet-view'),
            'log': document.getElementById('log-view'),
            'weight': document.getElementById('weight-view')
        };
        const recipeListView = document.getElementById('recipe-list-view');
        const recipesGrid = document.getElementById('recipes-grid');
        const recipesLoader = document.getElementById('recipes-loader');
        const logList = document.getElementById('log-list');
        const weightForm = document.getElementById('weight-form');
        const newWeightInput = document.getElementById('new-weight-input');
        const navButtons = document.querySelectorAll('.nav-btn');
        const errorMessageDiv = document.getElementById('error-message');
        const startWeightEl = document.getElementById('start-weight');
        const currentWeightEl = document.getElementById('current-weight');
        const totalChangeEl = document.getElementById('total-change');
        const weightHistoryListEl = document.getElementById('weight-history-list');
        const lipoedemaDietBtn = document.getElementById('lipoedema-diet-btn');
        const generalDietBtn = document.getElementById('general-diet-btn');
        const dietLoader = document.getElementById('diet-loader');
        const dietListContainer = document.getElementById('diet-list-container');
        const dietListContent = document.getElementById('diet-list-content');
        const copyDietBtn = document.getElementById('copy-diet-btn');
        const categoryButtons = document.querySelectorAll('.category-btn');
        const backToCategoriesBtn = document.getElementById('back-to-categories-btn');
        const recipeListTitle = document.getElementById('recipe-list-title');
        const refreshCategoryBtn = document.getElementById('refresh-category-btn');

        // --- HATA GÖSTERİM FONKSİYONU ---
        function showError(message) { errorMessageDiv.textContent = message; errorMessageDiv.classList.remove('hidden'); }

        // --- GÖRÜNÜM DEĞİŞTİRME ---
        function switchView(viewName) {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) views[viewName].classList.remove('hidden');
            navButtons.forEach(btn => {
                const isSelected = btn.dataset.view === viewName;
                btn.classList.toggle('text-cyan-400', isSelected);
                btn.classList.toggle('bg-cyan-500/10', isSelected);
                btn.classList.toggle('text-gray-400', !isSelected);
                btn.classList.toggle('hover:bg-gray-700/50', !isSelected);
            });
        }

        // --- VERİ YÖNETİMİ (localStorage) ---
        function loadDataFromStorage() {
            try {
                dailyLog = JSON.parse(localStorage.getItem('gulerDetoxLog')) || [];
                weightData = JSON.parse(localStorage.getItem('gulerDetoxWeight')) || [];
            } catch (e) { console.error("Yerel veriler okunurken hata oluştu:", e); dailyLog = []; weightData = []; }
        }
        function saveLogToStorage() { localStorage.setItem('gulerDetoxLog', JSON.stringify(dailyLog)); }
        function saveWeightToStorage() { localStorage.setItem('gulerDetoxWeight', JSON.stringify(weightData)); }

        // --- RENDER FONKSİYONLARI ---
        function renderAll() { renderLog(); renderWeightView(); }
        
        function renderRecipes(recipes) {
            recipesGrid.innerHTML = '';
            if (!Array.isArray(recipes) || recipes.length === 0) {
                recipesLoader.classList.remove('hidden');
                recipesLoader.textContent = 'Uygun tarif bulunamadı veya bir hata oluştu.';
                refreshCategoryBtn.classList.add('hidden');
                return;
            }
            recipesLoader.classList.add('hidden');
            refreshCategoryBtn.classList.remove('hidden');
            recipes.forEach((recipe, index) => {
                const card = document.createElement('div');
                card.className = "bg-white/10 backdrop-blur-sm rounded-2xl p-6 shadow-lg border border-white/20 flex flex-col";
                card.innerHTML = `<div class="flex-grow"><h3 class="text-2xl font-bold text-cyan-300 mb-2">${recipe.recipeName}</h3><p class="text-gray-300 mb-4 text-sm">${recipe.description||''}</p><div class="mb-4"><h4 class="font-semibold text-lg text-white mb-2">Malzemeler</h4><ul class="list-disc list-inside text-gray-300 space-y-1">${(recipe.ingredients||[]).map(ing=>`<li>${ing}</li>`).join('')}</ul></div><div><h4 class="font-semibold text-lg text-white mb-2">Hazırlanışı</h4><ol class="list-decimal list-inside text-gray-300 space-y-1">${(recipe.instructions||[]).map(step=>`<li>${step}</li>`).join('')}</ol></div></div><button data-recipe-index="${index}" class="add-log-btn mt-6 w-full bg-cyan-500 hover:bg-cyan-400 text-slate-900 font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors duration-300"><i data-lucide="plus-circle" class="w-5 h-5"></i> Bugün Bunu İçtim</button>`;
                recipesGrid.appendChild(card);
            });
            lucide.createIcons();
        }

        function renderLog() {
            logList.innerHTML = '';
            const sortedLog = [...dailyLog].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            if (sortedLog.length === 0) { logList.innerHTML = '<p class="text-gray-400">Henüz bir şey içmediniz.</p>'; return; }
            sortedLog.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = "bg-gray-800/50 p-3 rounded-lg flex justify-between items-center";
                logItem.innerHTML = `<span class="font-semibold text-gray-200">${log.recipeName}</span><span class="text-xs text-gray-400">${new Date(log.timestamp).toLocaleString('tr-TR')}</span>`;
                logList.appendChild(logItem);
            });
        }

        function renderWeightView() {
            const sortedWeight = [...weightData].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            if (sortedWeight.length > 0) {
                const startWeight = sortedWeight[0].weight;
                const currentWeight = sortedWeight[sortedWeight.length - 1].weight;
                const change = currentWeight - startWeight;
                startWeightEl.textContent = `${startWeight.toFixed(1)} kg`;
                currentWeightEl.textContent = `${currentWeight.toFixed(1)} kg`;
                totalChangeEl.textContent = `${change.toFixed(1)} kg`;
                totalChangeEl.classList.remove('text-green-400', 'text-red-400');
                if (change < 0) totalChangeEl.classList.add('text-green-400');
                else if (change > 0) totalChangeEl.classList.add('text-red-400');
                weightHistoryListEl.innerHTML = '';
                [...sortedWeight].reverse().forEach(entry => {
                    const item = document.createElement('div');
                    item.className = 'bg-gray-800/50 p-3 rounded-lg flex justify-between items-center text-sm';
                    item.innerHTML = `<span class="text-gray-300">${new Date(entry.timestamp).toLocaleDateString('tr-TR')}</span><span class="font-semibold">${entry.weight.toFixed(1)} kg</span>`;
                    weightHistoryListEl.appendChild(item);
                });
            } else {
                startWeightEl.textContent = `- kg`; currentWeightEl.textContent = `- kg`; totalChangeEl.textContent = `- kg`;
                weightHistoryListEl.innerHTML = '<p class="text-gray-400 text-sm">Henüz kilo kaydı girmediniz.</p>';
            }
            renderWeightChart(sortedWeight);
        }

        function renderWeightChart(data) {
            const ctx = document.getElementById('weight-chart').getContext('2d');
            const labels = data.map(w => new Date(w.timestamp).toLocaleDateString('tr-TR'));
            const weights = data.map(w => w.weight);
            if (weightChart) weightChart.destroy();
            weightChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'Kilo (kg)', data: weights, borderColor: '#2DD4BF', backgroundColor: 'rgba(45, 212, 191, 0.1)', fill: true, tension: 0.2 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, ticks: { color: '#9CA3AF' }, grid: { color: '#4A5568' } }, x: { ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(0,0,0,0)' } } }, plugins: { legend: { display: false } } }
            });
        }
        
        function getBackupRecipes() {
            return [ { recipeName: "Lipödem Destek Çorbası", description: "API limitine ulaşıldığında gösterilen, ödem atıcı ve iltihap azaltıcı özelliklere sahip şifalı bir çorba.", ingredients: ["1 adet pırasa", "2 adet kereviz sapı", "1 adet havuç", "1/2 demet maydanoz", "1 çay kaşığı zerdeçal", "1 parça taze zencefil", "4 su bardağı su", "Tuz, karabiber"], instructions: ["Tüm sebzeleri doğrayın.", "Su ile birlikte bir tencereye alın ve sebzeler yumuşayana kadar pişirin.", "Zerdeçal, rendelenmiş zencefil, tuz ve karabiberi ekleyip karıştırın.", "Blender'dan geçirerek pürüzsüz hale getirin ve sıcak servis yapın."] }, { recipeName: "Yeşil Enerji Suyu", description: "API limitine ulaşıldığında gösterilen, güne zinde başlamak için harika bir seçenek.", ingredients: ["1 avuç ıspanak", "1 adet salatalık", "1/2 yeşil elma", "1/2 limonun suyu", "1 su bardağı su"], instructions: ["Tüm malzemeleri blender'a atın.", "Pürüzsüz bir kıvam alana kadar yüksek hızda karıştırın.", "Soğuk olarak tüketin."] } ];
        }

        // --- API İŞLEMLERİ ---
        async function fetchFromAPI(prompt, schema) {
            errorMessageDiv.classList.add('hidden');
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { 
                contents: chatHistory,
                generationConfig: { responseMimeType: "application/json", responseSchema: schema }
            };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error?.message || `API Hatası: ${response.status}.`);
                const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!responseText) throw new Error("API'den geçerli bir yanıt alınamadı.");
                chatHistory.push({ role: "model", parts: [{ text: responseText }] }); 
                return responseText;
            } catch (e) {
                console.error("Gemini API hatası:", e);
                showError(`API hatası: ${e.message}. Lütfen daha sonra tekrar deneyin.`);
                return null;
            }
        }

        async function fetchRecipes(category) {
            recipeListView.classList.remove('hidden');
            recipesLoader.classList.remove('hidden');
            recipesGrid.innerHTML = '';
            refreshCategoryBtn.classList.add('hidden');
            refreshCategoryBtn.dataset.category = category;
            
            const categoryTitles = { detox: "Genel Detoks Tarifleri", lipoedema: "Lipödem Destek Çorbaları", diuretic: "Ödem Atıcı İçecekler" };
            recipeListTitle.textContent = categoryTitles[category];

            const creativityBooster = ["mevsimsel malzemelerle", "enerji verici", "ferahlatıcı", "antioksidan zengini", "farklı bir baharat kullanarak", "sindirim sistemini destekleyen"];
            const randomTheme = creativityBooster[Math.floor(Math.random() * creativityBooster.length)];
            const basePrompt = `Bana kilo vermeye odaklı, ${randomTheme} hazırlanan 4 adet tarif ver.`;
            const categoryPrompts = {
                detox: `${basePrompt} Bu tarifler genel detoks amaçlı olsun.`,
                lipoedema: `${basePrompt} Bu tarifler özellikle lipödem hastaları için uygun, iltihap azaltıcı ve ödem atıcı özelliklere sahip 'detoks çorbası' olsun.`,
                diuretic: `${basePrompt} Bu tarifler ödem atıcı, ferahlatıcı ve soğuk içecekler olsun.`
            };
            
            chatHistory = []; 
            const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { recipeName: { type: "STRING" }, description: { type: "STRING" }, ingredients: { type: "ARRAY", items: { type: "STRING" } }, instructions: { type: "ARRAY", items: { type: "STRING" } } }, required: ["recipeName", "description", "ingredients", "instructions"] } };
            const resultText = await fetchFromAPI(categoryPrompts[category], schema);
            
            recipesLoader.classList.add('hidden');
            if (resultText) {
                try {
                    const parsedData = JSON.parse(resultText);
                    if (!Array.isArray(parsedData)) throw new Error();
                    localRecipes = parsedData;
                } catch {
                    showError("API'den tarif formatı anlaşılamadı."); localRecipes = getBackupRecipes();
                }
            } else {
                showError("Günlük API limitine ulaşıldı. Sizin için hazırladığımız özel tarifler gösteriliyor.");
                localRecipes = getBackupRecipes();
            }
            renderRecipes(localRecipes);
        }

        async function fetchDietList(type) {
            lipoedemaDietBtn.disabled = true; generalDietBtn.disabled = true;
            dietLoader.classList.remove('hidden');
            dietListContainer.classList.add('hidden');
            chatHistory = [];
            const prompt = type === 'lipoedema'
                ? "Bana lipödem hastaları için uygun, 7 günlük, sabah, öğle, akşam ve ara öğünleri içeren detaylı bir diyet listesi oluştur. Listeyi JSON formatında, her gün için bir obje içeren bir dizi olarak ver. Her obje 'gun', 'sabah', 'araOgun1', 'ogle', 'araOgun2', ve 'aksam' alanlarını içermelidir."
                : "Bana genel sağlıklı yaşam ve kilo kontrolü için, 7 günlük, sabah, öğle, akşam ve ara öğünleri içeren dengeli bir diyet listesi oluştur. Listeyi JSON formatında, her gün için bir obje içeren bir dizi olarak ver. Her obje 'gun', 'sabah', 'araOgun1', 'ogle', 'araOgun2', ve 'aksam' alanlarını içermelidir.";
            
            const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { gun: {type: "STRING"}, sabah: {type: "STRING"}, araOgun1: {type: "STRING"}, ogle: {type: "STRING"}, araOgun2: {type: "STRING"}, aksam: {type: "STRING"} }, required: ["gun", "sabah", "ogle", "aksam"] } };
            const resultText = await fetchFromAPI(prompt, schema);
            
            dietLoader.classList.add('hidden');
            if(resultText) {
                try {
                    const parsedData = JSON.parse(resultText);
                    renderDietTable(parsedData);
                    dietListContainer.classList.remove('hidden');
                } catch {
                    showError("Diyet listesi formatı anlaşılamadı.");
                }
            }
            lipoedemaDietBtn.disabled = false; generalDietBtn.disabled = false;
        }
        
        function renderDietTable(data) {
            dietListContent.innerHTML = '';
            if(!Array.isArray(data)) return;
            const table = document.createElement('table');
            table.className = 'diet-table';
            const thead = document.createElement('thead');
            thead.innerHTML = '<tr><th>Gün</th><th>Sabah</th><th>Ara Öğün</th><th>Öğle</th><th>Ara Öğün</th><th>Akşam</th></tr>';
            table.appendChild(thead);
            
            const tbody = document.createElement('tbody');
            data.forEach(day => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${day.gun || ''}</strong></td>
                    <td>${day.sabah || ''}</td>
                    <td>${day.araOgun1 || '-'}</td>
                    <td>${day.ogle || ''}</td>
                    <td>${day.araOgun2 || '-'}</td>
                    <td>${day.aksam || ''}</td>
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            dietListContent.appendChild(table);
        }

        // --- UYGULAMA BAŞLATMA VE YÖNETİMİ ---
        function main() {
            lucide.createIcons();
            switchView('recipe-categories');
            loadDataFromStorage();
            renderAll();

            navButtons.forEach(btn => btn.addEventListener('click', () => {
                const view = btn.dataset.view;
                if (view === 'recipe-categories') {
                    recipeListView.classList.add('hidden');
                }
                switchView(view);
            }));
            
            categoryButtons.forEach(btn => btn.addEventListener('click', () => fetchRecipes(btn.dataset.category)));
            refreshCategoryBtn.addEventListener('click', (e) => fetchRecipes(e.currentTarget.dataset.category));
            backToCategoriesBtn.addEventListener('click', () => recipeListView.classList.add('hidden'));
            lipoedemaDietBtn.addEventListener('click', () => fetchDietList('lipoedema'));
            generalDietBtn.addEventListener('click', () => fetchDietList('general'));

            weightForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const weightValue = newWeightInput.value;
                if (!weightValue || isNaN(parseFloat(weightValue))) return;
                weightData.push({ weight: parseFloat(weightValue), timestamp: new Date().toISOString() });
                saveWeightToStorage();
                renderWeightView();
                newWeightInput.value = '';
            });

            recipesGrid.addEventListener('click', (e) => {
                const button = e.target.closest('.add-log-btn');
                if (!button) return;
                const recipeIndex = button.dataset.recipeIndex;
                const recipe = localRecipes[recipeIndex];
                if (recipe) {
                    dailyLog.push({ recipeName: recipe.recipeName, timestamp: new Date().toISOString() });
                    saveLogToStorage();
                    renderLog();
                    button.textContent = 'Eklendi!';
                    button.classList.add('bg-green-500');
                    setTimeout(() => {
                        button.innerHTML = `<i data-lucide="plus-circle" class="w-5 h-5"></i> Bugün Bunu İçtim`;
                        button.classList.remove('bg-green-500');
                        lucide.createIcons();
                    }, 2000);
                }
            });

            copyDietBtn.addEventListener('click', () => {
                const table = dietListContent.querySelector('table');
                if(!table) return;
                let textToCopy = '';
                for (const row of table.rows) {
                    let rowText = [];
                    for(const cell of row.cells) { rowText.push(cell.innerText.replace(/\n/g, ' ')); }
                    textToCopy += rowText.join('\t') + '\n';
                }
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = textToCopy;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextArea);
                copyDietBtn.textContent = 'Kopyalandı!';
                setTimeout(() => {
                    copyDietBtn.innerHTML = `<i data-lucide="copy" class="w-4 h-4"></i> Kopyala`;
                    lucide.createIcons();
                }, 2000);
            });
        }

        // Uygulamayı başlat
        main();
    </script>
</body>
</html>
